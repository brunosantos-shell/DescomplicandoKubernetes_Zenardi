- name: Configurar Control Plane
  hosts: control_plane
  become: yes
  tasks:
    - name: Verificar se cluster já existe
      stat:
        path: /etc/kubernetes/admin.conf
      register: kube_conf

    - name: Inicializar Cluster (Kubeadm Init)
      # Pega o IP privado da própria máquina para o advertise (ansible_default_ipv4.address)
      shell: |
        kubeadm init --pod-network-cidr=10.10.0.0/16 --apiserver-advertise-address={{ ansible_default_ipv4.address }} --skip-phases=addon/kube-proxy
      when: not kube_conf.stat.exists

    - name: Criar pasta .kube para o usuário ubuntu
      file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copiar admin.conf para o usuário
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        remote_src: yes
        owner: ubuntu
        group: ubuntu

    - name: Instalar Cilium CLI
      shell: |
        CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)
        CLI_ARCH=amd64
        curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
        tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
        rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
      args:
        creates: /usr/local/bin/cilium

    - name: Instalar Cilium no Cluster
      become: yes
      become_user: ubuntu
      shell: cilium install --version 1.15.1
      ignore_errors: yes # Ignora se já estiver instalado

    - name: Gerar token de Join
      shell: kubeadm token create --print-join-command
      register: join_command_raw

    - name: Definir fato com o comando de join
      set_fact:
        join_command: "{{ join_command_raw.stdout }}"